<!DOCTYPE html>
<html>
<head>
    <title>å€™è£œæ—¥ç¢ºå®š</title>
    <link rel="stylesheet" href="/static/style.css">

    <style>
        .tab-buttons { margin-bottom: 20px; }
        .tab-buttons button {
            padding: 10px 15px; margin-right: 5px;
            cursor: pointer; border: 1px solid #333;
            background: #f0f0f0;
        }
        .tab-buttons button.active { background: #3498db; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .date-large { font-size: 20px; font-weight: bold; }
        .confirmed { background: #c5ffc8; }
    </style>

</head>
<body>

<h1>æ—¥ç¨‹ç®¡ç†</h1>

<!-- ğŸ”¹ æœˆã‚¿ãƒ– -->
<div class="tab-buttons">
    {% for y, m in candidates_by_tab.keys() %}
        <button class="tab-btn" id="btn-{{ y }}-{{ m }}" data-tab="{{ y }}-{{ m }}">
            {{ y }}å¹´{{ m }}æœˆ
        </button>
    {% endfor %}
</div>

<!-- ğŸ”¹ ã‚¿ãƒ–ã”ã¨ã®ä¸­èº« -->
{% for y, m in candidates_by_tab.keys() %}
{% set key = y ~ "-" ~ m %}
<div class="tab-content" id="tab-{{ key }}">

    <h2>{{ y }}å¹´{{ m }}æœˆã®å€™è£œæ—¥ä¸€è¦§</h2>
    <table border="1">
        <tr>
            <th>æ—¥ä»˜</th><th>ä½“è‚²é¤¨</th><th>æ™‚é–“</th>
            <th>ç¢ºå®š</th><th>ç·¨é›†</th><th>å‰Šé™¤</th>
        </tr>

        {% for c in candidates_by_tab[(y, m)] %}
        <tr class="{% if c.id in confirmed_ids %}confirmed{% endif %}">
            <td class="date-large">{{ c.md }}</td>
            <td>{{ c.gym }}</td>
            <td>{{ c.start }}ã€œ{{ c.end }}</td>

            <td>
                {% if c.id in confirmed_ids %}
                    <form method="POST" action="{{ url_for('unconfirm', candidate_id=c.id) }}">
                        <button style="background:#e67e22; color:white;">ç¢ºå®šè§£é™¤</button>
                    </form>
                {% else %}
                    <form method="POST" action="{{ url_for('confirm') }}">
                        <input type="hidden" name="candidate_id" value="{{ c.id }}">
                        <button>ç¢ºå®š</button>
                    </form>
                {% endif %}
            </td>

            <td>
                <form method="GET" action="{{ url_for('edit_candidate', id=c.id) }}">
                    <button>ç·¨é›†</button>
                </form>
            </td>

            <td>
                <form method="POST" action="{{ url_for('delete_candidate', id=c.id) }}">
                    <button onclick="return confirm('ã“ã®å€™è£œæ—¥ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')">å‰Šé™¤</button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </table>

    <br><hr>

    <h2>{{ y }}å¹´{{ m }}æœˆã®ç¢ºå®šæ¸ˆã¿æ—¥ç¨‹</h2>
    <table border="1">
        <tr>
            <th>æ—¥ä»˜</th><th>ä½“è‚²é¤¨</th><th>æ™‚é–“</th>
            <th>å‚åŠ äººæ•°</th><th>ä¸å‚åŠ äººæ•°</th>
            <th>å‚åŠ ãƒ¡ãƒ³ãƒãƒ¼</th><th>ä¸å‚åŠ ãƒ¡ãƒ³ãƒãƒ¼</th>
            <th>ç·¨é›†</th>
        </tr>

        {% for confirm, c in confirmed_by_tab.get((y, m), []) %}
            {% set summary = attendance_summary.get(confirm.id, {}) %}
            <tr>
                <td class="date-large">{{ c.md }}</td>
                <td>{{ c.gym }}</td>
                <td>{{ c.start }}ã€œ{{ c.end }}</td>
                <td>{{ summary.attend_count or 0 }}</td>
                <td>{{ summary.absent_count or 0 }}</td>
                <td>{{ summary.attend_members | join(", ") if summary.attend_members else "-" }}</td>
                <td>{{ summary.absent_members | join(", ") if summary.absent_members else "-" }}</td>
                <td>
                    <a href="{{ url_for('manage_event_attendance', event_id=confirm.id) }}" class="btn">å‚åŠ è€…ç·¨é›†</a>
                </td>
            </tr>
        {% endfor %}
    </table>

</div>
{% endfor %}

<br>
<a href="{{ url_for('admin_menu') }}">ç®¡ç†è€…ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸æˆ»ã‚‹</a>

<script>
/* ğŸ”¥ ã‚¿ãƒ–åˆ‡æ›¿ */
function activateTab(key) {
    document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));

    document.getElementById('tab-' + key).classList.add('active');
    document.getElementById('btn-' + key).classList.add('active');

    localStorage.setItem('confirmTab', key);
}

/* ã‚¿ãƒ–ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ */
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => activateTab(btn.dataset.tab));
});

/* å‰å›è¡¨ç¤ºã‚¿ãƒ–ã‚’å¾©å…ƒ */
window.addEventListener('DOMContentLoaded', () => {
    const saved = localStorage.getItem('confirmTab');
    const first = document.querySelector('.tab-btn')?.dataset.tab;
    activateTab(saved || first);
});
</script>

</body>
</html>
